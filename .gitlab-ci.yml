stages:
  - build
  - test
  - publish

build-mongo:
  stage: build
  image: microsoft/dotnet:sdk
  tags:
    - docker
  script:
    - dotnet publish src/i18u.Repositories.Mongo -c Release -o out
    - mkdir out
    - cp -r src/i18u.Repositories.Mongo/out ./out/i18u.Repositories.Mongo

test-mongo:
  stage: test
  image: microsoft/dotnet:sdk
  dependencies: []
  coverage: '/i18u\.Repositories\.Mongo \| ([\d\.]+)%/'
  tags:
    - docker
  script:
    - dotnet test src/i18u.Repositories.Tests /p:CollectCoverage=true 

publish-mongo:
  stage: publish
  dependencies: []
  only:
    - tags
  tags:
    - docker
  script:
    - dotnet pack -c Release -p:PackageVersion=$CI_COMMIT_TAG src/i18u.Repositories.Mongo -o $(pwd)/out # I have $pwd here to support a future breaking change (3.0)
    - dotnet nuget push -s http://202.91.44.44:37623/v3/index.json out/i18u.Repositories.Mongo.$CI_COMMIT_TAG.nupkg